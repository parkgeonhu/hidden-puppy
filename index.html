<!DOCTYPE HTML>

<head>
    <title>20171622 박건후 기말 프로젝트</title>

    <script>
        var stageNum = 2;
        var nowStage = 0;

        var stageAnswerCntArr = [3, 5, 8];
        var stageCheckAvailArr=[6, 10, 16];
        var stageWaitingTimeArr=[3000, 5000, 7000];
        var stageGameTimeArr=[7,12,17];
        
        var startTime;
        var timerId=null;


        var answerArr = [];

        var userClickCnt=0;
        var isClickedStartBtn=false;
        var userFailClickCnt=0;
        
        
        //[TO-DO] 게임 클리어해서 넘어갈 때 스코어보드 초기화 작업
        function scoreBoard(){
            var scene= document.getElementById("board_view");
            var boardWrapper=document.createElement("div");
            
            boardWrapper.setAttribute("id","board_wrapper");
            
            
            var gameStartBtn=document.createElement("button");
            gameStartBtn.setAttribute("id","gameStartBtn");

            gameStartBtn.textContent="게임 시작"
            gameStartBtn.onclick = function() {
                scene=initScene(scene);
                init();
                let gameStartBtn=document.getElementById("gameStartBtn");
                gameStartBtn.style.display='none';
                createGameScene();
                isClickedStartBtn=true;
                
                //gameStartBtn.style.display='none';
            }
            
            var restClickView=document.createElement("p");
            restClickView.setAttribute("id","restClickView");
            restClickView.textContent="남은 클릭 횟수 : "+String(stageCheckAvailArr[nowStage]-userClickCnt)+"회";
            
            var failClickView=document.createElement("p");
            failClickView.setAttribute("id","failClickView");
            failClickView.textContent="실패 횟수 : "+userFailClickCnt+"회";
            
            
            var restPuppyView=document.createElement("p");
            restPuppyView.setAttribute("id","restPuppyView");
            restPuppyView.textContent="남은 강아지 수 : "+answerArr.length+"마리";
            
            var restTimeView=document.createElement("p");
            restTimeView.setAttribute("id","restTimeView");
            restTimeView.textContent="남은 시간 : "+stageGameTimeArr[nowStage]+"초";
            

            boardWrapper.appendChild(gameStartBtn);
            boardWrapper.appendChild(restClickView);
            boardWrapper.appendChild(failClickView);
            boardWrapper.appendChild(restPuppyView);
            boardWrapper.appendChild(restTimeView);

            scene.appendChild(boardWrapper);
            
        }
        
        function getElapseTime(){
            endTime = new Date();
            var timeDiff = endTime - startTime; //in ms
            // strip the ms
            timeDiff /= 1000;

            // get seconds 
            var seconds = Math.round(timeDiff);
            return seconds;
        }
        
        
        function updateScoreBoard(){
            
            
            
            let elapsedTime=stageGameTimeArr[nowStage]-getElapseTime();
            let restClickCnt=stageCheckAvailArr[nowStage]-userClickCnt;
            if(restClickCnt<=0 || elapsedTime==0){
                clearInterval(timerId);
                changeScene("lose");
            }
            
            var restClickView=document.getElementById("restClickView");
            restClickView.textContent="남은 클릭 횟수 : "+String(restClickCnt)+"회";
            var failClickView=document.getElementById("failClickView");
            failClickView.textContent="실패 횟수 : "+userFailClickCnt+"회";
            var restPuppyView=document.getElementById("restPuppyView");
            restPuppyView.textContent="남은 강아지 수 : "+answerArr.length+"마리";
            var restTimeView=document.getElementById("restTimeView");
            restTimeView.textContent="남은 시간 : "+elapsedTime+"초";
            
        }
    

        function checkAnswer(id, img) {
            
            
            let isAnswer=false;
            let answer_count = stageAnswerCntArr[nowStage];
            for (let i = 0; i < answerArr.length; i++) {
                if (id == answerArr[0]) {
                    isAnswer=true;
                    img.setAttribute("src", "media/img2.gif");
                    answerArr.shift();
                }
            }
            
            userClickCnt++;
            if(isAnswer==false){
                userFailClickCnt++;
            }
            
            if(answerArr.length==0){
                alert("정답을 모두 맞추었습니다!");
                nowStage++;
                changeScene("win");
            }
        }


        function createAnswer() {
            let answer_count = stageAnswerCntArr[nowStage];
            for (let i = 0; i < answer_count; i++) {
                var choiceValue = Math.floor(Math.random() * 24);
                let overlapCheck = false;
                for (let j = 0; j < i; j++) {
                    if (choiceValue == answerArr[j]) {
                        i--;
                        overlapCheck = true;
                        break;
                    }
                }
                if (!overlapCheck) {
                    answerArr.push(choiceValue);
                }
            }
        }
        
        function initScene(scene){
            while ( scene.hasChildNodes() ) {
                scene.removeChild( scene.firstChild );
            }
            return scene;
        }

        function gameOverScene() {
            
            console.log("gameover")
            var scene=document.getElementById("scene_view");
            scene=initScene(scene);
            var gameOverImg = document.createElement("IMG");
            gameOverImg.setAttribute("src", "media/gameover.jpg");
            gameOverImg.setAttribute("id", "gameover_img");
            
            scene.appendChild(gameOverImg);
        }
        
        function init(){
            clearInterval(timerId);
            
            answerArr=[];
            userClickCnt=0;
            userFailClickCnt=0;
            let scene=document.getElementById("scene_view");
            initScene(scene);
            scene=document.getElementById("board_view");
            initScene(scene);
            createAnswer();
            scoreBoard();
            

        }

        function changeScene(status) {
            switch(status){
                case "win":
                    if(nowStage<=stageNum){
                        init();
                        waitingScene();
                    }
                    else{
                        alert("축하합니다. 모든 스테이지를 깨셨습니다.");
                    }
                    break;
                case "lose":
                    gameOverScene();
                    break;
            }
        }
        
        
        // 게임시작
        function waitingScene() {
            var scene = document.getElementById("scene_view");
            var egg_wrapper = document.createElement("div");
            egg_wrapper.setAttribute("id", "egg_wrapper");
            
            for (let i = 0; i < 24; i++) {
                let imgSrc = "media/img1.gif";
                let eggImg = document.createElement("IMG");
                eggImg.setAttribute("src", imgSrc);
                eggImg.setAttribute("id", "egg_img");
                egg_wrapper.appendChild(eggImg);
            }
            scene.appendChild(egg_wrapper);

        }

        
        // 게임 시작
        function createGameScene() {
            var scene = document.getElementById("scene_view");
            var egg_wrapper = document.createElement("div");
            egg_wrapper.setAttribute("id", "egg_wrapper");

            let tempImgArr=[];
            for (let i = 0; i < 24; i++) {
                var eggImg = document.createElement("IMG");
                eggImg.setAttribute("id", "egg_img");
                
                let imgSrc = "media/img1.gif";
                for (let j = 0; j < stageAnswerCntArr[nowStage]; j++) {
                    if (i==answerArr[j]) {
                        imgSrc = "media/egg/egg" + String(j + 1 + ".png");
                        eggImg.setAttribute("src", imgSrc);
                        
                        break;
                    }
                }
                
                tempImgArr.push(eggImg);
                
                eggImg.setAttribute("src", imgSrc);
                
                egg_wrapper.appendChild(eggImg);
            }
            scene.appendChild(egg_wrapper);
            
            
            
            
            setTimeout(function() {
                for (let i = 0; i < tempImgArr.length; i++) {
                    let imgSrc = "media/img1.gif";
//                    for (let j = 0; j < stageAnswerCntArr[nowStage]; j++){
//                        if (i==answerArr[j]) {
//                            imgSrc = "media/egg/egg" + String(j + 1 + ".png");
//                            eggImg.setAttribute("src", imgSrc);    
//                            break;
//                        }
//                    }
                    tempImgArr[i].setAttribute("src", imgSrc);
                    tempImgArr[i].onclick = function() {
                        checkAnswer(i, this);
                    }
                }
                
                startTime = new Date();
                timerId=setInterval(updateScoreBoard,1000);
                
            },stageWaitingTimeArr[nowStage]);
        }

    </script>

    <style>
        body {
            width: 98%;
            
        }

        #game_wrapper {
            width: 98%;
            /*            background-color: antiquewhite;*/
        }

        #scene_view {
            margin-left: 2%;
            margin-right: 2%;
            background-color: #CEFF84;
            width: 75%;
            float: left;
        }

        #board_view {
            background-color: aqua;
            margin-left: 2%;
            margin-right: 2%;
            width: 15%;
            float: left;
        }

        #egg_img {
            width: 6%;
            margin: 3%;
        }

        #gameover_img {
            width: 100%;
        }

    </style>
</head>


<body onload="init();waitingScene();">
    <div id="game_wrapper">
        <div id="header">Header</div>
        <div id="nav">Nav</div>
        <div id="board_view"></div>
        <div id="scene_view">
        </div>
        <div id="footer">Footer</div>
    </div>
</body>
